<!DOCTYPE html>
<html>
  <head>
    <title>Embeddable Map Example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet&#45;0.6.2/leaflet.css" /> -->
    <!-- <!&#45;&#45;[if lte IE 8]> -->
    <!--   <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet&#45;0.6.2/leaflet.ie.css" /> -->
    <!-- <![endif]&#45;&#45;> -->
    <style>
    </style>
  </head>
  <body>

    <div class="container">
      <div class="map"></div>
    </div>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/mustache.js/0.7.2/mustache.min.js"></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.6.2/leaflet.js"></script>

    <script>

      var sldPrefix = "https://raw.github.com/groundtruth/gt_public_styles/master/sld/";

      var servers = {
        gt: {
          url: "http://basemap{s}.pozi.com/geoserver/wms",
          options: { subdomains: "1234" }
        },
        depi: {
          url: "http://services.land.vic.gov.au/catalogue/publicproxy/guest/sdm_geoserver/wms",
          options: {}
        }
      };

      var layers = {
        poziBase: { server: servers.gt, options: { layers: "VICMAP_CLASSIC:VicmapClassic", tiled: true } }
      };

      var centers = {
        gtHQ: [-37.815933, 144.965785]
      }

      var examples = [
        {
          title: "Bushfire prone areas in two different styles",
          description: "To mark big areas you can either use a transpar style (value:0.3, left) or different marks as slash-lines (right).",
          views: [
            { center: centers.gtHQ, zoom: 10, span: 6 },
            { center: centers.gtHQ, zoom: 10, span: 6 }
          ],
          layers: [
            [layers.poziBase, { server: servers.depi, options: { layers: "sii:BUILDINGREG.BUSHFIRE_PRONE_AREA", sld: sldPrefix + "sii-BUILDINGREG.BUSHFIRE_PRONE_AREA.sld" } } ],
            [layers.poziBase, { server: servers.depi, options: { layers: "sii:BUILDINGREG.BUSHFIRE_PRONE_AREA_GEN", sld: sldPrefix + "sii-BUILDINGREG.BUSHFIRE_PRONE_AREA_GEN.sld" } } ]
          ]
        }
      ];

      var egTemplate = ' \
        <div class="row example"> \
          <div class="span12"> \
            <h2>{{title}}</h2> \
            {{#description}} \
              <p>{{description}}</p> \
            {{/description}} \
            <div class="row"> \
              {{#views}} \
                <div id="eg{{egIndex}}view{{viewIndex}}" class="span{{span}} map"></div> \
              {{/views}} \
            </div> \
          </div> \
        </div> \
      ';

      var defaultLayerOptions = {
        format: 'image/png',
        transparent: true
      };

      _(examples).each(function(eg, egIndex) {

        var viewData = {
          title: eg.title,
          description: eg.description,
          views: _(eg.views).map(function(view, viewIndex) {
            return $.extend({}, view, { egIndex: egIndex, viewIndex: viewIndex });
          })
        };

        $(".map").append(Mustache.render(egTemplate, viewData));

        _(_.range(eg.views.length)).each(function(viewIndex) {
          var view = eg.views[viewIndex];
          var layers = eg.layers[viewIndex];

          var map = L.map(["eg", egIndex, "view", viewIndex].join('')).setView(view.center, view.zoom);
          map.attributionControl.setPrefix("");
          // map.attributionControl.setPosition("bottomleft");
          map.attributionControl.addAttribution(view.attribution);

          _(layers).each(function(config) {
            var layerClass = config.options.tiled ? L.TileLayer.WMS : L.SingleTileWMSLayer;
            var layer = new layerClass(config.server.url, $.extend({},
              defaultLayerOptions,
              config.server.options,
              config.options
            ));
            layer.addTo(map);
          });

        });

      });

    </script>
  </body>
</html>

